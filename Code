import asyncio
import requests
import asyncpg
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command

BOT_TOKEN = "7619297853:AAHiUMgtIkdkIYczOXh0dLNdLgprJtM21r0"
API_key = "db82390453211da75e6a36e0d43674d6"

DB_CONFIG = {
    "host": "localhost",
    "port": 5432,
    "database": "weather_bot",
    "user": "postgres",
    "password": ""
}

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    user_id = message.from_user.id
    username = message.from_user.username
    first_name = message.from_user.first_name

    try:
        conn = await asyncpg.connect(**DB_CONFIG)
        await conn.execute('''
            INSERT INTO users (user_id, username, first_name) 
            VALUES ($1, $2, $3)
            ON CONFLICT (user_id) DO UPDATE SET
            username = EXCLUDED.username,
            first_name = EXCLUDED.first_name
        ''', user_id, username, first_name)
        await conn.close()

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")

    await message.answer("–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–≥–æ–¥—É –≤ —Ç–≤–æ–µ–º –≥–æ—Ä–æ–¥–µ!\n"
                         "–ù–∞–ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞, –∏ —è –ø–æ–∫–∞–∂—É —Ç–µ–±–µ —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É!")

@dp.message()
async def get_weather(message: types.Message):
    city = message.text.strip()

    try:
        url = f"http://api.openweathermap.org/data/2.5/weather?q={city}&appid={API_key}&units=metric&lang=ru"

        response = requests.get(url)
        data = response.json()

        if response.status_code == 200:
            temp = data['main']['temp']
            humidity = data['main']['humidity']
            wind_speed = data['wind']['speed']
            description = data['weather'][0]['description']
            city_name = data['name']

            answer = (
                f"üåç –ü–æ–≥–æ–¥–∞ –≤ –≥–æ—Ä–æ–¥–µ {city_name}:\n"
                f"üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {temp}¬∞C\n"
                f"üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: {humidity}%\n"
                f"üí® –°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞: {wind_speed} –º/—Å\n"
                f"‚òÅÔ∏è –û–ø–∏—Å–∞–Ω–∏–µ: {description.capitalize()}"
            )

            await message.answer(answer)

        else:
            await message.answer("‚ùå –ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞!")

    except Exception as e:
        await message.answer("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–≥–æ–¥—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

async def main():
    print("The Weather Bot is starting")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
